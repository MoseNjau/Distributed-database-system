# =============================================================
# PostgreSQL 15 — Primary / OLTP Configuration
# Production-Grade Streaming Replication Settings
# =============================================================

# ── CONNECTION ────────────────────────────────────────────────
listen_addresses = '*'
max_connections = 200
port = 5432

# ── MEMORY ───────────────────────────────────────────────────
shared_buffers = 256MB
work_mem = 16MB
maintenance_work_mem = 128MB
effective_cache_size = 768MB

# ── WRITE-AHEAD LOG (WAL) ─────────────────────────────────────
wal_level = replica                   # Required for streaming replication
max_wal_size = 2GB
min_wal_size = 1GB
wal_keep_size = 2048                  # Keep 2GB of WAL segments for replicas
wal_log_hints = on                    # Required for pg_rewind
checkpoint_completion_target = 0.9

# ── REPLICATION ───────────────────────────────────────────────
max_wal_senders = 10                  # Max concurrent replication connections
max_replication_slots = 10            # Allow physical replication slots
hot_standby = on                      # Allow reads on standby (also good for primary)
synchronous_commit = on               # Durability: commits wait for WAL flush

# ── ARCHIVING (WAL Archiving for PITR) ──────────────────────
archive_mode = on
archive_command = 'test ! -f /archive/%f && cp %p /archive/%f'
archive_timeout = 300                 # Archive segment every 5 minutes at latest

# ── QUERY TUNING ─────────────────────────────────────────────
default_statistics_target = 100
random_page_cost = 1.1
effective_io_concurrency = 200
enable_partitionwise_join = on
enable_partitionwise_aggregate = on

# ── CONCURRENCY & LOCKING ────────────────────────────────────
deadlock_timeout = 1s
lock_timeout = 30s
idle_in_transaction_session_timeout = 60s

# ── LOGGING ──────────────────────────────────────────────────
logging_collector = on
log_directory = 'pg_log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 1000    # Log queries taking > 1s
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_timezone = 'UTC'

# ── AUTOVACUUM ────────────────────────────────────────────────
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 30s
autovacuum_vacuum_scale_factor = 0.05
autovacuum_analyze_scale_factor = 0.02

# ── TIMEZONE ─────────────────────────────────────────────────
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
